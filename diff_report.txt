
InputObject                                                         
-----------                                                         
        // Handle invalid concurrency (e.g. -1 for disabled) to a...
        const workerCount = Math.max(0, Math.min(concurrency, que...
        if (workerCount === 0)                                      
            return [];                                              
        const workers = Array(workerCount)                          
    onunload() {                                                    
        if (this.autoSyncInterval) {                                
            window.clearInterval(this.autoSyncInterval);            
        // Initialize SecureStorage                                 
        // Ensure credentials are loaded into adapter               
            this.adapter.updateConfig(credentials.clientId, crede...
            this.adapter.setTokens(credentials.accessToken, crede...
        // Ensure data dir exists                                   
        const dataDir = `${this.manifest.dir}/${DATA_REMOTE_DIR}`;  
        if (!(await this.app.vault.adapter.exists(dataDir))) {      
            await this.app.vault.createFolder(dataDir).catch(() =...
        // Save to data.json in new layout                          
        const dataPath = `${dataDir}/data.json`;                    
        await this.app.vault.adapter.write(dataPath, JSON.stringi...
        // For compatibility with VaultSync mobile/other versions...
        await this.saveData(this.settings);                         
        // Ensure new directories exist                             
        // List of files to move from root to data/remote           
        const remoteFiles = ["sync-index.json", "data.json"];       
        for (const file of remoteFiles) {                           
            const oldPath = `${this.manifest.dir}/${file}`;         
            const newPath = `${this.manifest.dir}/${DATA_REMOTE_D...
                const content = await this.app.vault.adapter.read...
                await this.app.vault.adapter.write(newPath, conte...
            .setDesc(t("settingCheckStatus"))                       
            .addButton((button) => button.setButtonText(t("settin...
            const isAuthed = await this.plugin.adapter.isAuthenti...
            if (isAuthed) {                                         
                new obsidian.Notice(t("noticeAuthSuccess"));        
                new obsidian.Notice(t("noticeAuthFailed"));         
            .addButton((button) => button                           
            .setButtonText(t("settingLogin"))                       
            .setCta()                                               
            .onClick(() => {                                        
            this.plugin.adapter.login();                            
        // Mobile/Manual Auth                                       
        if (!obsidian.Platform.isDesktop) {                         
                .setName(t("settingAuthorize"))                     
                .setPlaceholder(t("settingManualAuthPlaceholder"))  
                // We don't save immediately, wait for verify button
            }))                                                     
                .addButton((button) => button.setButtonText(t("se...
                const inputEl = containerEl.querySelector('input[...
                const codeOrUrl = inputEl === null || inputEl ===...
                if (codeOrUrl) {                                    
                    await this.plugin.adapter.handleCallback(code...
                    if (await this.plugin.adapter.isAuthenticated...
                        new obsidian.Notice(t("noticeAuthSuccess"));
                    else {                                          
                        new obsidian.Notice(t("noticeAuthFailed")); 
            this.plugin.settings.cloudRootFolder = value || "Obsi...
        // 5. Exclusion                                             
                .setPlaceholder(".git\nnode_modules\n*.tmp")        
        // 6. Developer                                             
                .setDesc(t("settingStartupDelayDesc"))              
                .addText((text) => text                             
                .setPlaceholder("10")                               
                .onChange(async (value) => {                        
            }));                                                    
                                                                    
                                                                    
//# sourceMappingURL=data:application/json;charset=utf-8;base64,e...
        const workers = Array(Math.min(concurrency, queue.length))  
        // Initialize SecureStorage with the secret                 
        // Load credentials from Secure Storage                     
            this.adapter.setCredentials(credentials.clientId || "...
            this.adapter.setTokens(credentials.accessToken || nul...
        // MIGRATION: Check if legacy credentials exist in data.j...
        const data = this.settings;                                 
        if (data && (data.clientId || data.accessToken)) {          
            console.log("VaultSync: Migrating credentials to secu...
            await this.saveCredentials(data.clientId || "", data....
            // Access settings directly to delete properties        
            const settingsAny = this.settings;                      
            delete settingsAny["clientId"];                         
            delete settingsAny["clientSecret"];                     
            delete settingsAny["accessToken"];                      
            delete settingsAny["refreshToken"];                     
            delete settingsAny["refreshToken"];                     
            await this.saveSettings();                              
            console.log("VaultSync: Migration complete.");          
        const dataPath = `${this.manifest.dir}/${DATA_REMOTE_DIR}...
            // Ensure directory exists                              
            const dir = `${this.manifest.dir}/${DATA_REMOTE_DIR}`;  
                await this.app.vault.createFolder(dir);             
            await this.app.vault.adapter.write(dataPath, JSON.str...
        catch (e) {                                                 
            console.error("VaultSync: Failed to save settings", e); 
        const moves = [                                             
            { old: "data.json", new: `${DATA_REMOTE_DIR}/data.jso...
            { old: "sync-index.json", new: `${DATA_REMOTE_DIR}/sy...
            { old: "sync-index_raw.json", new: `${DATA_REMOTE_DIR...
            { old: "communication.json", new: `${DATA_REMOTE_DIR}...
            { old: "local-index.json", new: `${DATA_LOCAL_DIR}/lo...
            { old: "dirty.json", new: `${DATA_LOCAL_DIR}/dirty.js...
            // Note: .sync-state migration handled/accessed by Se...
            // but we can move it here if it exists in old standa...
            // SecureStorage handles its own path logic, but let'...
            { old: ".sync-state", new: `${DATA_LOCAL_DIR}/.sync-s...
        // Ensure directories exist                                 
        ];                                                          
            if (!(await this.app.vault.adapter.exists(dir))) {      
        for (const move of moves) {                                 
            const oldPath = `${this.manifest.dir}/${move.old}`;     
            const newPath = `${this.manifest.dir}/${move.new}`;     
                try {                                               
                    // Copy then remove to be safe                  
                    // Or read/write/delete                         
                    const content = await this.app.vault.adapter....
                    await this.app.vault.adapter.writeBinary(newP...
                    await this.app.vault.adapter.remove(oldPath);   
                    console.log(`VaultSync: Migrated ${move.old} ...
                catch (e) {                                         
                    console.error(`VaultSync: Failed to migrate $...
                }                                                   
    async saveCredentials(clientId, clientSecret, accessToken, re...
        this.adapter.setCredentials(clientId, clientSecret);        
        this.adapter.setTokens(accessToken, refreshToken);          
        await this.secureStorage.saveCredentials({                  
            clientId,                                               
            clientSecret,                                           
            accessToken,                                            
            refreshToken,                                           
        try {                                                       
        const scrollPos = containerEl.scrollTop;                    
        containerEl.addClass("vault-sync-settings-container");      
            .setDesc(this.plugin.adapter.getAuthStatus())           
            .addButton((button) => button.setButtonText(t("settin...
            .setName(t("settingClientId"))                          
            .setDesc(t("settingClientIdDesc"))                      
            .addText((text) => text.setValue(this.plugin.adapter....
            // Update adapter temporarily so config is live         
            this.plugin.adapter.updateConfig(value, this.plugin.a...
            // Persist securely                                     
            await this.plugin.saveCredentials(value, this.plugin....
            .setName(t("settingClientSecret"))                      
            .setDesc(t("settingClientSecretDesc"))                  
            .addText((text) => text.setValue(this.plugin.adapter....
            // Update adapter temporarily                           
            this.plugin.adapter.updateConfig(this.plugin.adapter....
            // Persist securely                                     
            await this.plugin.saveCredentials(this.plugin.adapter...
            .addButton((button) => button.setButtonText(t("settin...
            await this.plugin.adapter.login();                      
            if (!obsidian.Platform.isMobile) {                      
                const tokens = this.plugin.adapter.getTokens();     
                await this.plugin.saveCredentials(this.plugin.ada...
                await this.plugin.syncManager.notify(t("noticeAut...
                this.display();                                     
        if (obsidian.Platform.isMobile) {                           
            // Manual Auth (Mobile Fallback)                        
            let textComponent;                                      
                .addText((text) => {                                
                textComponent = text;                               
                text.setPlaceholder(t("settingManualAuthPlacehold...
                    "100%";                                         
            })                                                      
                .addButton((btn) => {                               
                btn.setButtonText(t("settingManualAuthVerify")).o...
                    const val = textComponent.getValue().trim();    
                    if (!val)                                       
                        return;                                     
                    let code = val;                                 
                    if (val.includes("code=")) {                    
                        try {                                       
                            const url = new window.URL(val);        
                            code = url.searchParams.get("code") |...
                        }                                           
                        catch (e) {                                 
                            // ignore                               
                        }                                           
                    try {                                           
                        await this.plugin.adapter.exchangeCodeFor...
                        const tokens = this.plugin.adapter.getTok...
                        await this.plugin.saveCredentials(this.pl...
                        await this.plugin.syncManager.notify(t("n...
                    catch (e) {                                     
                        await this.plugin.syncManager.notify(`${t...
                    }                                               
                });                                                 
            })                                                      
                .setClass("auth-manual-input");                     
            this.display();                                         
        }));                                                        
        new obsidian.Setting(containerEl)                           
            // Validation: empty or invalid -> default              
            const sanitized = value.trim();                         
            if (!sanitized ||                                       
                sanitized.startsWith("/") ||                        
                sanitized.includes("\\") ||                         
                sanitized.length > 255 ||                           
                /[<>:"|?*]/.test(sanitized)) {                      
                this.plugin.settings.cloudRootFolder = "ObsidianV...
                this.plugin.settings.cloudRootFolder = sanitized;   
            this.plugin.adapter.updateConfig(this.plugin.adapter....
        }));                                                        
        // 5. Exclusion Patterns                                    
        new obsidian.Setting(containerEl)                           
                .setPlaceholder("*.tmp\ntemp/**\n.git/**")          
                this.plugin.syncManager.triggerFullCleanup();       
        // 6. Developer (Hidden by default, enable via data.json:...
                .setDesc(t("settingStartupDelayDesc") +             
                `\n(Min: ${SETTINGS_LIMITS.startupDelay.min}, Max...
        }                                                           
        // Restore scroll position                                  
        containerEl.scrollTop = scrollPos;                          
            }                                                       
            }                                                       
        });                                                         
//# sourceMappingURL=data:application/json;charset=utf-8;base64,e...


