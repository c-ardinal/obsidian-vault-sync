# VaultSync (Obsidian Cloud Sync)

Obsidian向けの高速・インテリジェントなクラウドストレージ同期プラグインです。  
Google Driveを活用し、PCとモバイルデバイス（iOS/Android）間での強固なデータ一貫性と高速な同期体験を提供します。

---

## ✨ 主な特徴

- **インテリジェント同期 (Index Shortcut)**: クラウド上のマスターインデックスを共有。変更がない場合は全走査をスキップし、バッテリーと通信量を節約します。
- **高速差分検知 (MD5 Adoption)**: インデックスが未作成の状態でも、ファイルのMD5ハッシュを計算して照合。一致すれば無駄なダウンロードを行わず即座に採用します。
- **モバイル最適化**: 基盤に `fetch` APIを採用し、デスクトップ/モバイルの両方で動作。編集停止時の自動同期（Debounce）やレイアウト変更トリガーを搭載。
- **設定・プラグインの同期**: `.obsidian` フォルダの選択的同期に対応。プラグインやショートカット設定をデバイス間で共有できます（一時ファイルやキャッシュは自動除外）。
- **安全な認証 & 保存**: PKCEを用いたOAuth2認証。認証情報は設定ファイルから分離され、専用のセキュアストレージ（バイナリ形式）に保存されます。

---

## 🚀 セットアップ手順

本プラグインを利用するには、Google Cloud Project を作成して **自分専用の Client ID / Client Secret** を取得する必要があります。

### 1. Google Cloud Project の作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセスします。
2. 新しいプロジェクトを作成します。
3. 「APIとサービス」 > 「ライブラリ」から **Google Drive API** を検索し、「有効にする」を押します。

### 2. OAuth 同意画面の設定

1. 「APIとサービス」 > 「OAuth 同意画面」 > 「概要」から「開始」を押します。
2. アプリ情報を入力して下さい。User Type は「外部」を選択してください。
3. 全て記入したら「作成」を押します。
4. **スコープの追加**: `.../auth/drive` （Google ドライブのすべてのファイルの表示、編集、作成、削除）を追加します。
    - _注: グローバルなVault発見とフォルダのクリーンアップに必要です。_
5. **テストユーザーの追加**: 「対象」からテストユーザーの「Add users」を押して自分の Google メールアドレスを追加します。

### 3. 認証情報 (Client ID / Secret) の作成

1. 「APIとサービス」 > 「認証情報」 > 「認証情報を作成」 > 「OAuth 2.0 クライアント ID」を選択します。
2. アプリケーションの種類として **「デスクトップ アプリ」** を選択して作成します。
    - _注: PC・モバイルの両方でこのタイプを使用することを推奨します。_
3. 生成された **クライアント ID** と **クライアント シークレット** をコピーします。

### 4. プラグインへの反映

1. Obsidian の設定 > 「VaultSync」を開きます。
2. IDとシークレットを入力し、「Authorize」ボタンを押します。
3. **認証の完了**:
    - **PCの場合**: ブラウザが起動し、自動的に認証が完了します。
    - **モバイルの場合**:
        1. ブラウザで認証後「サイトに接続できません (localhost)」というエラー画面になります。
        2. その**エラー画面のURLを丸ごとコピー**します。
        3. Obsidianに戻り、設定画面の「手動認証」欄に貼り付けて「検証」を押すと完了します。

---

## 🛠 開発とビルド

開発環境で実行、またはソースからビルドする場合：

### ビルド

```bash
npm run build
```

ビルド結果は `dist/` ディレクトリ配下に以下の形式で出力されます。配布時はこのフォルダの中身をプラグインフォルダへコピーしてください。

- `main.js`
- `manifest.json`
- `styles.css`

---

## 🔧 同期エンジンの仕様

- **Conflict Resolution**: 競合発生時はローカルファイルを `(Conflict YYYY-MM-DD)` として退避し、クラウド側を正本として受け入れます。
- **Selective Sync**: `.obsidian/` 内の `workspace.json`, `cache/`, `backups/` 等は自動的に同期対象から除外されます。
- **Atomic Updates**: 各ファイル転送完了ごとに個別のインデックスエントリを更新。中断されても次回の再開が容易です。

---

## ライセンス

MIT License
