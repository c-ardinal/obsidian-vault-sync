# 3-wayマージ テキスト同期 テスト仕様書 (v1.3)

## 1. 目的

本テストスイートは、`diff-match-patch` (DMP) を利用した行ベースの3-wayマージエンジンの精度を検証し、データの予期せぬ消失（Silent Data Loss）や構造の破壊を防止することを目的とする。v1.2の再々レビュー指摘（H〜K）を完全に反映し、Match_Distance の再定義、テーブル構文の修正、およびインライン競合の前提（Baseの行分割）を整理した。

## 2. 検証環境 (DMP パラメータ)

- **Match_Threshold**: 0.5 (しきい値。半分以上の文脈一致で位置特定)
- **Match_Distance**: 250 (探索距離。パッチの期待位置からこの行数以上ズレた場合は適用を失敗させる)
- **Patch_Margin**: 1 (行ベースマージにおける文脈行数。前後1行を考慮)
- **Added-Line Protection**: 有効（Localで追加された行が消失した場合、あるいは過度な一括削除を検知した場合にマージ結果を拒否）
- **Intra-line Merge**: 無効（将来の拡張課題）

## 3. 合否判定基準

1. **データ消失ゼロ**: Added-line protectionにより、Local側の追加行が1行でも消えたら「失敗」とする。
2. **構造維持**: YAML, テーブル, コードブロックの基本構文がマージ後に破壊されていないこと。
3. **衝突検出の正確性**: 同一行内（インライン）の編集、または探索距離超過があった場合、不正にマージせず「null（衝突）」を返すこと。
4. **冪等性**: 同一入力（Base/Local/Remote）に対するマージ結果が常に同一であること。
5. **パフォーマンス**: 5000行以下のファイルにおいて、マージ処理が3秒以内に完了すること。

---

## 4. テストケース詳細

### 【Group 1】YAML Frontmatter & Metadata (001-015)

※成功を期待するケースは、Baseにおいて各要素が独立した行であることを前提とする。

| ID  | Base                   | Local                | Remote              | 期待結果                                 |
| :-- | :--------------------- | :------------------- | :------------------ | :--------------------------------------- |
| 001 | tags: []\nstatus: todo | status: done         | tags: [work]        | 両方反映 (tags: [work], status: done)    |
| 002 | date: 01-01            | date: 01-02 (m)      | date: 01-01 (c)     | **コンフリクト検出** (同一行編集)        |
| 003 | title: Hello           | author: Alice (追記) | source: web (追記)  | 各独立行であれば両方入り維持             |
| 004 | desc: "L1\nL2"         | desc: "Mod1\nL2"     | desc: "L1\nMod2"    | 別行の変更をマージ                       |
| 005 | desc: "A\nB\nC"        | desc: "A\nB2\nC"     | desc: "A\nB\nC\nD"  | 中間の更新と末尾の追加を両立             |
| 006 | tags:\n - t1           | tags:\n - t1\n - t2  | tags:\n - t1\n - t3 | **マージ成功** (Block記法による別行追加) |
| 007 | tags: [t1] (1行)       | tags: [t1, t2]       | tags: [t1, t2]      | 両側同一編集。t2として収束               |
| 008 | tags: [x, y]           | tags: [y] (x削除)    | tags: [x, y, z]     | **コンフリクト検出** (同一行編集)        |
| 009 | a: 1\nb: 2             | a: 9\nb: 2           | a: 1\nb: 8          | **マージ成功** (独立行であれば成功)      |
| 010 | key: val               | key: changed_A       | key: changed_B      | コンフリクト検出 (null)                  |
| 011 | --- (Start/End)        | 冒頭にID追加         | 末尾にDate追加      | YAML構造を維持し両キー追加               |
| 012 | --- \n Body            | YAML内編集           | Body内編集          | セパレーター位置を維持し両方反映         |
| 013 | --- \n Text            | --- 削除             | Text 編集           | コンフリクト検出（構造破壊）             |
| 014 | [[Link1]]\n[[Link2]]   | [[Link1\|A]]         | [[Link2\|B]]        | 両方のリンク修正を維持                   |
| 015 | #tag1                  | #tag1 (削除)         | #tag2 (追記)        | 別行であれば成功                         |

### 【Group 2】Markdown Tables (016-030)

| ID  | Base               | Local             | Remote           | 期待結果                              |
| :-- | :----------------- | :---------------- | :--------------- | :------------------------------------ |
| 016 | \| A \| B \|       | \| A2 \| B \|     | \| A \| B2 \|    | **コンフリクト検出** (同一行編集)     |
| 017 | 10行テーブル       | 2行目セル修正     | 9行目セル修正    | 離れた行のセル更新を両立              |
| 018 | 3行テーブル        | 末尾に Row4 追加  | 末尾に Row5 追加 | Row4とRow5が並んで追加                |
| 019 | Row1\nRow2         | Row1\nNew\nRow2   | Row1\nRow2\nNew2 | 中間挿入と末尾追加を両立              |
| 020 | Header\n---\nData1 | データの値を編集  | ヘッダー名を編集 | 表構造を維持して両方反映 (別行)       |
| 021 | \| 1 \| 2 \|       | \| 1 \| 2 \| 3 \| | \| 12 \|         | **コンフリクト検出** (同一行の不整合) |
| 022 | \| \| \n \| \|     | 1行目埋め         | 2行目埋め        | 別行であればマージ成功                |
| 023 | 5行テーブル        | 2行目を削除       | 4行目を編集      | 削除行以外は正常に反映                |
| 024 | \| A \|            | \| B \|           | \| C \|          | コンフリクト検出 (null)               |
| 025 | 1行テーブル        | 奇数行追加(3, 5)  | 偶数行追加(2, 4) | 全ての行が順序よく並ぶ                |
| 026 | Text\nTable        | Textを大幅加筆    | 表内の値を編集   | 文脈を見失わず両方反映                |
| 027 | Table\nText        | 表の下に追記      | 表内の値を編集   | 境界を超えず両方反映                  |
| 028 | 200行テーブル      | 5行目編集         | 150行目編集      | 文脈がユニークなら **マージ成功**     |
| 029 | \| A \| B \|       | \| A \| B \| C \| | (Bのカラム削除)  | コンフリクト検出（構造不整合）        |
| 030 | T1\n...\nT2        | T1内編集          | T2内編集         | 別々のテーブルの変更を両立            |

### 【Group 3】Task List & Nested List (031-050)

| ID  | Base               | Local                 | Remote             | 期待結果                              |
| :-- | :----------------- | :-------------------- | :----------------- | :------------------------------------ |
| 031 | - [ ] T1\n- [ ] T2 | - [x] T1              | - [x] T2           | 両方のタスクが完了                    |
| 032 | - T1               | - New\n- T1           | - T1\n- End        | 先頭と末尾に項目追加                  |
| 033 | - T1\n- T2         | - T1\n- A\n- T2       | - T1\n- B\n- T2    | 決定論的挿入 (Local A, Remote B の順) |
| 034 | - Item             | \t- Item (インデント) | - Item (内容編集)  | **コンフリクト検出** (同一行編集)     |
| 035 | L1\n\tL2\n\t\tL3   | L3 編集               | L1 編集            | 階層を維持して両方反映                |
| 036 | - A\n- B           | - B (A削除)           | - A\n- B (B編集)   | A削除とB編集を両立                    |
| 037 | - Item             | \* Item (記法変更)    | - Item 修正        | **コンフリクト検出** (同一行編集)     |
| 038 | 1. A\n2. B         | 1. A\n1.1 New\n2. B   | 1. A\n2. B (B編集) | 番号付きでの中間挿入と編集の両立      |
| 039 | - [ ] Task         | - [x] Task            | - [x] Task         | 同一内容編集による収束                |
| 040 | - Task\n note      | - Task-upd            | note-upd           | 親編集と継続行編集の両立              |
| 041 | 10行リスト         | 奇数行を完了          | 偶数行を完了       | 10行全てが完了状態                    |
| 042 | - A\n- B           | - B\n- A (入替)       | - A-mod            | **コンフリクト検出** (移動未対応)     |
| 043 | L1\n\nL2           | L1の上の空行へ編集    | L2の上の空行へ編集 | 空行の整合性を維持                    |
| 044 | \t- Item           | - Item (戻す)         | \t- Item 加筆      | **コンフリクト検出** (同一行編集)     |
| 045 | 10個のタスク       | 上5個を完了           | 下5個を完了        | 10個全て完了                          |
| 046 | Bullet + Num       | Bullet追加            | Num追加            | 別行の構造を維持                      |
| 047 | - Line\n Cont      | Cont 編集             | Line 編集          | 継続行(2行目)と親行の独立マージ成功   |
| 048 | - [ ] T1 #tag      | #tag -> #new          | - [x] T1           | **コンフリクト検出** (同一行編集)     |
| 049 | Level 5 List       | L5 編集               | L1 編集            | 離れた階層の独立マージ成功            |
| 050 | - [Link](uri)      | Label 更新            | uri 更新           | **コンフリクト検出** (同一行編集)     |

### 【Group 4】Code Blocks (051-065)

| ID  | Base            | Local                     | Remote              | 期待結果                             |
| :-- | :-------------- | :------------------------ | :------------------ | :----------------------------------- |
| 051 | func() {\n}     | // Comment (先頭)         | \treturn; (末尾)    | 関数冒頭と末尾の両方反映             |
| 052 | { \n a=1\n}     | \t\ta=1 (2行目インデント) | a=2 (2行目内容内容) | **コンフリクト検出** (同一行編集)    |
| 053 | ```py           | ```python                 | block内編集         | 言語タグ変更と中身の両立             |
| 054 | `\na\n`         | `\na\nb\n`                | `\na\nc\n`          | ブロック末尾への連続追加。両立       |
| 055 | text\n`\n...\n` | text修正                  | code修正            | 物理的境界を越えず独立して反映       |
| 056 | B1\n...\nB2     | B1内のみ編集              | B2内のみ編集        | 別のブロックの混同なし               |
| 057 | }\n}\n}         | 中間の } を ] へ          | 足りない } を追記   | 文脈(前後行)を参考に位置特定         |
| 058 | if (c) {        | if (c) { // upd           | (行削除)            | コンフリクト（一方が消した行を編集） |
| 059 | /_ doc _/       | doc内容修正               | 末尾に @param 追記  | コメントブロック内の両立             |
| 060 | config: val     | config: new               | another: key        | 別々の設定キーの追加/更新を両立      |
| 061 | Python Code     | インデント(4行目)         | 1行ロジック(6行目)  | 別行のインデント構造維持             |
| 062 | CSS Braces      | property 加筆             | selector 名変更     | セレクタ名変更とプロパティ加筆両立   |
| 063 | SQL Query       | JOIN 追記                 | WHERE 修正          | 複数行のSQLを壊さずマージ            |
| 064 | <script>        | tag 内編集                | tag 外編集          | HTML/Script タグペアを維持           |
| 065 | Embedded MD     | 内部MDの # 編集           | 外部MDへの追記      | 入れ子になった構文の整合性維持       |

### 【Group 5】Daily Journal & Logs (066-085)

| ID  | Base          | Local                           | Remote                | 期待結果                                  |
| :-- | :------------ | :------------------------------ | :-------------------- | :---------------------------------------- |
| 066 | Start\nEnd    | Morning Add                     | Night Add             | 冒頭と末尾の追加。両立                    |
| 067 | 10:00 Log     | 11:00 Insert                    | 12:00 Insert          | 指定行順に並んで挿入                      |
| 068 | L1\nL2        | L1\nL1.1\nL2                    | L1\nL2-mod            | 挿入と既存行編集(L2)の両立                |
| 069 | Hello         | Hello (fix typo)                | Hello. (add dot)      | **コンフリクト検出** (同一行編集)         |
| 070 | Old Log       | Old Log (upd)                   | New Log (app)         | 過去ログ修正と新規ログ追記の両立          |
| 071 | Rapid Logs    | 3回連続追記                     | 他デバイスから1点編集 | 履歴バースト中の変更を欠損させない        |
| 072 | 300行ファイル | 先頭に300行挿入 + 280行目を修正 | 元20行目を編集        | **Match_Distance(250)超過でコンフリクト** |
| 073 | A\n\n\nB      | 2つ目の空行に注記               | 3つ目の空行に注記     | 連続空行内の位置特定に成功                |
| 074 | L1\nL2        | L1 (L2と結合)                   | L2 (内容編集)         | コンフリクト (結合元が編集された)         |
| 075 | ID: 001       | ID: 002 (修正)                  | Desc: text (加筆)     | **コンフリクト検出** (同一行編集)         |
| 076 | 文1\n文2      | 文1修正                         | 文2加筆               | 日本語の独立行編集成功                    |
| 077 | (かっこ)      | 内容を (詳細) へ                | ) の外へ加筆          | **コンフリクト検出** (同一行編集)         |
| 078 | 文1\n文2      | 文1修正                         | 文2修正               | 独立行であれば成功                        |
| 079 | 文1\n文2      | 文1の間に改行                   | 文2 修正              | 行の分割と別行編集の両立                  |
| 080 | 😃\n🚀        | 😄 (置換)                       | 🛸 (追記)             | 絵文字1文字(サロゲートペア)を正確に扱う   |
| 081 | Space         | 全角 -> 半角                    | 文字列加筆            | **コンフリクト検出** (同一行編集)         |
| 082 | Eng\nJp       | Eng 修正                        | Jp 修正               | 英和独立行編集成功                        |
| 083 | 多重空行      | 5行空行的位置を維持             | その前後の文章修正    | 空間コンテキストを壊さない                |
| 084 | [http://..]   | https へ修正                    | [Label] へ修正        | **コンフリクト検出** (同一行編集)         |
| 085 | [^1]: Ref     | Ref 内容修正                    | 本文に [^1] 追記      | 脚注定義と参照の独立編集成功              |

### 【Group 6】Structural & Scale (086-100)

| ID  | Base                       | Local               | Remote              | 期待結果                          |
| :-- | :------------------------- | :------------------ | :------------------ | :-------------------------------- |
| 086 | Chapter A                  | 他の場所へ移動      | 内容修正            | **コンフリクト検出** (移動未対応) |
| 087 | 100行テキスト              | 真ん中10行削除      | 最終行編集          | 削除と編集を両立                  |
| 088 | 長文全域                   | (Local側) 全消去    | 1行修正             | **Mass Deletion検出により阻止**   |
| 089 | P1\nP2                     | P2\nP1 (入替)       | P1 加筆             | **コンフリクト検出** (移動未対応) |
| 090 | サロゲート1\nサロゲート2   | サロゲート1 置換    | サロゲート2 置換    | Unicodeバイト列を壊さず成功       |
| 091 | $ \alpha $\n$ \beta $      | $ \gamma $ (L1置換) | $ \delta $ (L2追記) | **マージ成功** (数式独立行)       |
| 092 | <div>\n</div>              | <div> 属性追記      | 境界の外側に加筆    | タグペアを維持                    |
| 093 | > [!INFO] Title\n> content | Title 修正 (L1)     | 中身加筆 (L2)       | **マージ成功** (別行編集)         |
| 094 | URL1\nURL2                 | URL1 修正           | URL2 修正           | 独立したURL行の同時修正成功       |
| 095 | (BOMあり)                  | 文字列追記          | BOM削除             | エンコード不整合を検知/防止       |
| 096 | (Base=空)                  | Local 1行追記       | (なし)              | マージ成功 (Local内容のみ)        |
| 097 | 2000行ファイル             | 1000行目編集        | 1005行目編集        | 互いに位置不変のため成功          |
| 098 | 5000行ファイル             | プロパティ修正      | 文末追記            | 3秒以内に完了すること             |
| 099 | Tab行\nSpace行             | Tab行 修正          | Space行 修正        | インデント種別を破壊せず共存      |
| 100 | <!-- comment -->           | 内部テキスト修正    | 外部テキスト修正    | コメントアウト構造を維持          |

### 【Group 7】Boundary & Edge (101-112)

| ID  | カテゴリ               | Base             | Local            | Remote                            | 期待結果                       |
| :-- | :--------------------- | :--------------- | :--------------- | :-------------------------------- | :----------------------------- |
| 101 | Head                   | Line1 (Long)     | New\nLine1       | Line1-mod                         | 近点編集。文字列長があれば成功 |
| 102 | Tail                   | LineN (Long)     | LineN\nNew       | LineN-mod                         | EOF付近の整合性維持            |
| 103 | あAいBうC              | あXいBうC        | あAいBうY        | **コンフリクト検出** (同一行編集) |
| 104 | [10]: Ref10\n[1]: Ref1 | [10]: New        | [1]: New         | 参照リストの独立行編集成功        |
| 105 | ## Title (1)           | ## Title (1) + A | ## Title (1) + B | 同一文脈の別行挿入。成功          |
| 106 | 同一編集               | text             | modified         | modified                          | 1つの `modified` に収束        |
| 107 | 同一削除               | A\nB\nC          | A\nC (B削除)     | A\nC (B削除)                      | エラーなく削除反映             |
| 108 | 改行コード A           | LF               | CRLF化           | LF (内容編集)                     | 内容編集＋改行コード正規化     |
| 109 | 改行コード B           | (混在)           | LF正規化         | CRLF正規化                        | 最終的にLF等に統一             |
| 110 | 空Base                 | (空)             | A が新規入力     | B が新規入力                      | 行単位で並びA,B両方存在        |
| 111 | 冪等性テスト           | (任意)           | (任意)           | (任意)                            | 2回等価マージして結果が不変    |
| 112 | 衝突見逃しゼロ         | (明らかな衝突)   | A 編集           | B 編集                            | 確定的に `null` を返すこと     |

---

## 5. レビュー指摘事項 (2026-02-07)

### A. 致命的な問題

| #   | 対象              | 指摘                                                                                                                                                                                                                    |
| :-- | :---------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| A1  | **全ケース共通**  | **baseの内容が未定義。** 3-wayマージはbase/local/remoteの三つ組で決定されるため、「AがXした、BがYした」だけでは入力が一意に決まらない。各ケースにbase状態の明示が必須。                                                 |
| A2  | **Case 086, 089** | **DMP行ベースマージは「移動」を追跡できない。** 章の移動・段落の入れ替えはdelete+insertとして処理される。現エンジンでは期待結果の達成が原理的に不可能。仕様から除外するか、期待結果を「コンフリクト検出」に変更すべき。 |
| A3  | **Case 097**      | **Match_Distance=250は文字数（行ベースでは行数）。** 2000行目の編集はこの閾値を大幅に超える。期待結果「マッチング成功」は現パラメータでは不可能。閾値を引き上げるか、ケースの前提を修正すべき。                         |
| A4  | **Case 039**      | **期待結果が未確定（「要検証」）。** テスト仕様書に曖昧な期待結果があると合否判定不能。方針を決定して明記すべき。                                                                                                       |

### B. 構造・記述の問題

| #   | 対象                               | 指摘                                                                                                                                                              |
| :-- | :--------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| B1  | **Group 2 テーブル**               | ID 021の行でMarkdownテーブルのカラム数がずれている（余分な `\|` がある）。レンダリングが崩れる。                                                                  |
| B2  | **Case 007**                       | 「重複せず（または1つとして）」は曖昧。DMPは構文を理解しないため、同位置への同一行挿入は1行になるか2行重複になるかはdiff結果依存。期待動作を1つに絞るべき。       |
| B3  | **Case 012**                       | YAML境界線 `---` の移動はファイル全体の構造を変える破壊的操作。「境界が維持され」がどちらの位置を指すか不明。                                                     |
| B4  | **Case 029**                       | 「構造破壊を検知しコンフリクトさせる」はDMPマージ単体では不可能（テーブル構文の意味理解がない）。ポストマージバリデーションの実装が前提なら、その旨を明記すべき。 |
| B5  | **Case 046-050, 061-065, 076-085** | 複数ケースをまとめて記述しているが、各ケースの具体的なbase/local/remoteが不在。実装時にテストを書けない。最低限、各IDに1つの具体シナリオを割り当てるべき。        |

### C. カバレッジの欠落

| #   | 不足観点                         | 説明                                                                                      |
| :-- | :------------------------------- | :---------------------------------------------------------------------------------------- |
| C1  | **両者が同一行を同じ内容に編集** | 同一変更の重複検出（idempotent merge）の検証がない。                                      |
| C2  | **両者が同一範囲を削除**         | 削除の重複適用でマイナス行数にならないことの確認。                                        |
| C3  | **改行コード混在 (CR/LF/CRLF)**  | OS間同期では頻出。行分割が壊れるリスクの検証が必要。                                      |
| C4  | **baseが空ファイル**             | Case 096は片方が空だが、base自体が空の場合（新規ファイルの同時編集）がない。              |
| C5  | **マージ結果の冪等性**           | 同じ入力で2回マージして結果が同一であることの検証。非決定的動作の早期検出に有効。         |
| C6  | **パフォーマンス閾値**           | Case 098に「タイムアウトなく完了」とあるが、具体的な閾値（例: 5000行で3秒以内）が未定義。 |

### D. 合否判定基準への追加提案

現行の3基準に加え、以下を推奨：

4. **コンフリクト検出精度**: 本来コンフリクトであるケースの見逃し（偽陰性）が0件であること。
5. **冪等性**: 同一入力に対するマージ結果が常に同一であること。
6. **パフォーマンス**: 5000行以下のファイルでマージ処理が N秒以内に完了すること（Nは要定義）。

---

## 7. v1.1 再レビュー指摘事項 (2026-02-07)

### E. 致命的：行ベースマージと期待結果の矛盾

本仕様は「行ベース3-wayマージ」を前提としている（§2 Patch_Margin: 1, Line-based mode）。
**行ベースマージでは「行」が最小単位であり、同一行内の異なる箇所への変更であっても、両側が同一行を変更した時点でコンフリクトとなる。**

以下のケースは「同一行の異なる部分を変更 → 両立」を期待しているが、行ベースマージでは原理的に不可能。期待結果を「コンフリクト検出 (null)」に修正するか、行内マージ（文字レベルフォールバック）の実装を前提とするなら §2 にその旨を明記すべき。

| 対象ID | 問題の行          | Local変更      | Remote変更  | 備考                |
| :----- | :---------------- | :------------- | :---------- | :------------------ |
| 002    | `date: 01-01`     | 値をmodified   | 値をcreated | 同一行の値変更      |
| 009    | `p: {a: 1, b: 2}` | a=9            | b=8         | インラインYAMLは1行 |
| 016    | `\| A \| B \|`    | A→A2           | B→B2        | テーブル行は1行     |
| 034    | `- Item`          | インデント追加 | 内容編集    | 同一行              |
| 037    | `- Item`          | 記号変更       | 内容修正    | 同一行              |
| 044    | `\t- Item`        | インデント戻し | 加筆        | 同一行              |
| 048    | `- [ ] T1 #tag`   | タグ変更       | チェック    | 同一行              |
| 050    | `- [Link](uri)`   | Label変更      | uri変更     | 同一行              |
| 052    | `a=1`             | インデント変更 | a=2         | 同一行              |
| 069    | `Hello`           | typo修正       | 句点追加    | 同一行              |
| 075    | `ID: 001`         | ID修正         | 加筆        | 同一行              |

**推奨対応**: 上記11件は以下のいずれかで解決する。

1. 期待結果を「コンフリクト (null)」に統一する（現実装に忠実）
2. 行内の文字レベルフォールバックマージを実装し、§2 に「Intra-line Character Merge: 有効」を追記する
3. Base状態を複数行に分割し、Local/Remoteが異なる行を変更するシナリオに書き換える（例: Case 009 の `p:` を `a: 1\nb: 2` の2行に展開）

### F. ID欠番・件数不整合

| # | 指摘 |
+| :-- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
+| F1 | **ID 090-100 が欠番。** Group 6 は 086-089 の後に 101-105 へ飛んでいる。旧仕様の Unicode(090), LaTeX(091), HTML(092), Callout(093), URL(094), BOM(095), Zero-Length(096), 2000行(097), 5000行(098), インデント混在(099), コメントアウト(100) がすべて脱落している。特に 090(Unicode/サロゲートペア), 095(BOM), 099(Tab/Space混在) は実用上重要。 |
+| F2 | **総件数が不一致。** §1 で「112件」と宣言しているが、実際のID数を数えると 001-089(89件) + 101-112(12件) = **101件**。 |

### G. その他の問題

| # | 対象 | 指摘 |
+| :-- | :------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
+| G1 | **§番号の重複** | 「## 5. レビュー指摘事項」と「## 5. レビュー指摘事項への対応状況」で番号が重複している。後者を § 6 にすべき。 |
+| G2 | **Case 033** | 期待結果「(A,B)または(B,A)」は非決定的。テスト仕様として合否判定不能。実装の挿入順を調査し1つに確定すべき。 |
+| G3 | **Case 088** | 「Added-line Protectionにより衝突/阻止」とあるが、§3基準1は **Local側の追加行** の消失を検知する仕組み。本ケースはLocalが全消去する側なので、Localに追加行はなく、Protectionは発火しない可能性がある。「大量削除検出」等の別メカニズムが必要なら明記すべき。 |
+| G4 | **Case 021** | 列追加(Local)は既存行すべてのカラム数を変えるため、Remoteの行追加と行レベルで衝突する。「可能な限りマージ」は曖昧。コンフリクトとすべきか具体的な出力を定義すべき。 |
+| G5 | **Case 072 vs 028** | 072は500行で250超過→コンフリクト、028は200行で150行目編集→成功。しかし028のLocal=5行目、Remote=150行目の場合、パッチ適用位置が base の先頭から150行目であり Match_Distance(250) 内に収まるが、**パッチのコンテキスト行が一意に特定できるか**はテーブルの内容の類似度に依存する。Base内容にユニークな行が必要な旨を補足すべき。 |

---

## 8. 将来の拡張課題 (ロードマップ)

以下の機能は、現在の「行ベースマージ」の制限を超えるものであり、将来のバージョンでの対応を検討する。

1. **Intra-line Character Merge (行内マージ)**:
    - 同一行内の異なるオフセット（例：先頭のタグと末尾の単語）への変更を、文字レベルの3-wayマージで救済する機能。
    - これが実装された場合、Group 1, 2, 3 等の「コンフリクト検出」の多くが「マージ成功」に変わる。

2. **Structural Table Merge (構造的テーブルマージ)**:
    - Markdown Tableのカラム追加と行追加を意味論的に統合する機能。

3. **Block Move Tracking (ブロック移動追跡)**:
    - 章や段落の「移動」を検知し、移動先に対して編集を適用する機能。

---

## 9. レビュー指摘事項への対応状況

### 対応済 (v1.2 修正内容)

- **ID 090-100 の復旧**: 欠番となっていた重要ケース（Unicode/BOM/5000行等）を全て再定義し、F1/F2指摘を解決。
- **インライン競合の整理**: Case 002, 009, 016, 034 等、同一行の編集を全て「コンフリクト」に修正（指摘E対応）。
- **セクション番号の修正**: §5 と §6 の重複を解消（指摘G1対応）。
- **決定論的な期待値**: Case 033 等の並び順を「Local -> Remote」で固定（指摘G2対応）。
- **削除ガードの明文化**: Case 088 を Added-line protection 以外の判定器として定義（指摘G3対応）。
- **Base状態の具体化**: 全ケースに具体的な Base/Local/Remote を追記。

---

## 10. v1.2 再々レビュー指摘事項 (2026-02-07)

### H. インライン競合の修正漏れ (E指摘の残存)

v1.2で多くの同一行ケースをコンフリクトに修正したが、以下が漏れている。
YAML の `tags: [t1]` はフロー記法では **1行** であるため、行ベースマージでは両側の変更は衝突する。

| 対象ID | Base           | Local            | Remote            | 現在の期待結果      | 正しい期待結果            |
| :----- | :------------- | :--------------- | :---------------- | :------------------ | :------------------------ |
| 006    | `tags: [t1]`   | `tags: [t1, t2]` | `tags: [t1, t3]`  | 両方追加 [t1,t2,t3] | **コンフリクト** (同一行) |
| 007    | `tags: [t1]`   | `tags: [t1, t2]` | `tags: [t1, t2]`  | 重複せず収束        | マージ成功 (※後述)        |
| 008    | `tags: [x, y]` | `tags: [y]`      | `tags: [x, y, z]` | z追加x削除          | **コンフリクト** (同一行) |

**Case 007 の補足**: Local と Remote が同一行を **同じ内容** に変更した場合、diff上「Local=変更あり, Remote=同一変更」となる。DMPの patch_apply はRemote（=既に変更済み）に対してLocal差分を適用するが、コンテキストが一致するため適用成功し結果は正しい。ただし、これは Case 106（同一編集テスト）と重複するため、007 は YAML フロー記法固有の検証として差別化すべき。

**対応案**: Base を YAML ブロック記法（1タグ1行）に変更すれば非衝突にできる。

```yaml
# Block記法 (各タグが独立行 → 行ベースマージ可能)
tags:
    - t1
```

### I. Markdownテーブルの構造破損 (2箇所)

| #   | 行                         | 問題                                                                                                                                                                 |
| :-- | :------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| I1  | **141行 (Group 6 ヘッダ)** | セパレータ行の末尾に余分な列 `\| -------------------- \|` がある。レンダリングが崩れる。                                                                             |
| I2  | **147行 (Case 091)**       | 6列になっている。Remote列と期待結果列の間に余分な `\|` がある。正しくは「Base: 2行のLaTeX / Local: γ置換 / Remote: δ追記 / 期待: 数式行の独立編集成功」の4データ列。 |
| I3  | **165行 (Case 104)**       | 5列しかない（期待結果列が欠落）。Remoteと期待結果が結合されている。                                                                                                  |

### J. Match_Distance の誤解

**Case 072** の「500行ログ, 1行目編集 vs 499行目編集 → Match_Distance超過でコンフリクト」は **誤り**。

Match_Distance は「パッチの期待適用位置から、実際にマッチが見つかった位置までの距離」を制限する。

- Local が 1行目を編集 → パッチの期待位置は行0付近
- Remote は 499行目を編集しただけ → 1行目の位置は変わっていない（行0のまま）
- パッチ適用時の探索距離 = 0 → 250以内 → **成功**

Match_Distance が問題になるのは、**大量の挿入/削除によりコンテンツの位置がズレた場合** (例: Remoteが先頭に300行挿入 → Localのパッチが期待位置から300行ズレ → 250超過)。

同様に **Case 097** の「1000行目 vs 1005行目, 距離250以内」という注釈も、距離の意味を取り違えている。この2つのパッチは互いに干渉せず、どちらも期待位置で見つかる。

**推奨**: 072 は「500行ログ, 1行目編集 vs 499行目編集 → **マージ成功**」に修正。Match_Distance超過の正しいテストケースを別途作成する:

```
ID: 072 (修正案)
Base: 300行  Local: 先頭に260行挿入 + 280行目を編集  Remote: 元20行目を編集
→ Remote のパッチ期待位置=20, 実際位置=280 (260行ズレ) → 250超過 → コンフリクト
```

### K. その他

| #   | 対象                 | 指摘                                                                                                                                                                                                                                                                                      |
| :-- | :------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| K1  | **Case 055 (101行)** | `物理적境界` — `적` は韓国語の文字。正しくは `物理的境界`。                                                                                                                                                                                                                               |
| K2  | **Case 096 vs 110**  | 096 に「(ID 110と統合)」と注記があるが、両方のケースが存在している。統合するなら片方を削除するか、096 を「Base=空 + 片方だけ書き込み」に差別化すべき。                                                                                                                                    |
| K3  | **Case 001**         | `tags: [], status: todo` が1行なのか2行なのかが曖昧。1行なら Local/Remote 両方が同一行を変更するためコンフリクト。期待結果「両方反映」が成立するためには Base が複数行 (例: `tags: []\nstatus: todo`) である必要がある。明記すべき。                                                      |
| K4  | **Case 093**         | `> [!INFO] Title` は1行だが、Callout の中身 (`> content`) は別行。Local=Title修正(1行目), Remote=中身加筆(2行目以降) なら **別行** であり、コンフリクトではなくマージ成功のはず。期待結果を再検討すべき。                                                                                 |
| K5  | **Case 101-102**     | Local が行を挿入し、Remote が既存行を編集する場合、パッチの文脈行が Remote 上で変更されている。Match_Threshold=0.5 で `Line1` vs `Line1-mod` のマッチが成功するかは文字列長に依存し、結果が不安定になりうる。テストの前提条件（行の長さ等）を明記するか、境界条件であることを注記すべき。 |
