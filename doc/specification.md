# VaultSync - 仕様書

**Version**: 2.0
**Last Updated**: 2026-02-09

Obsidian向けクラウドストレージ同期プラグイン。ローカルのObsidian VaultとGoogle Drive上のフォルダを同期し、全プラットフォームでのデータ一貫性を保つ。

---

## 1. アーキテクチャ概要

### 1.1 コンポーネント構成

```
┌─────────────────────────────────────────────────────────┐
│                    main.ts (Plugin)                      │
│  イベント監視・UIコンポーネント・設定管理                │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                  SyncManager                             │
│  同期オーケストレーション・スケジューリング・状態管理     │
│  Smart Sync / Background Full Scan / 割り込み制御        │
│  3-way マージ / 競合解決 / 分散ロック                    │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│             CloudAdapter Interface (抽象層)               │
│  ┌──────────────┐  ┌──────────┐  ┌──────────┐           │
│  │ GoogleDrive  │  │ Dropbox  │  │ OneDrive │  ...      │
│  │ (実装済み)   │  │ (将来)   │  │ (将来)   │           │
│  └──────────────┘  └──────────┘  └──────────┘           │
└─────────────────────────────────────────────────────────┘
```

### 1.2 主要モジュール

| モジュール             | ファイル                   | 役割                                                                                                             |
| :--------------------- | :------------------------- | :--------------------------------------------------------------------------------------------------------------- |
| **SyncManager**        | `sync-manager.ts`          | 同期のオーケストレーション。Index管理、差分検知、Pull/Push分岐、3-wayマージ、分散ロック                          |
| **CloudAdapter**       | `types/adapter.ts`         | クラウドストレージ抽象化インターフェース                                                                         |
| **GoogleDriveAdapter** | `adapters/google-drive.ts` | Google Drive REST API実装。`fetch` APIベースでモバイル互換                                                       |
| **SecureStorage**      | `secure-storage.ts`        | 認証情報の保存。Obsidian Secret Storage (Keychain) を優先し、未対応環境では暗号化バイナリ (`.sync-state`) で保存 |
| **RevisionCache**      | `revision-cache.ts`        | 履歴コンテンツのセッション内キャッシュ                                                                           |
| **HistoryModal**       | `ui/history-modal.ts`      | 履歴確認・Diff表示・ロールバックUI                                                                               |
| **i18n**               | `i18n.ts`                  | 多言語対応 (ja/en)                                                                                               |

### 1.3 データ構造

#### Google Drive上のフォルダ構造

```
ObsidianVaultSync/           ← App Root (設定で変更可)
  └── <VaultName>/           ← Vault Root
       ├── notes             ← ユーザーファイル群
       └── .obsidian/        ← Obsidian 設定ファイル群 (選択同期)
            └──plugins
                 └── obsidian-vault-sync/ ← 本プラグイン配置フォルダ
```

- **Global Discovery**: `VaultName` と一致するフォルダをGoogle Drive内からグローバルに検索。見つかった場合は App Root 配下へ自動的に移動（Adoption）して統合する。

#### ローカルデータ

| ファイル                         | 場所                 | 用途                                                                       |
| :------------------------------- | :------------------- | :------------------------------------------------------------------------- |
| `sync-index.json`                | プラグインフォルダ内 | ローカルインデックス（ファイルハッシュ・mtime・ancestorHash等）            |
| `.sync-state`                    | `data/local/`        | 暗号化認証情報（Keychain未対応時のフォールバック。移行後は自動削除される） |
| `open-data.json/local-data.json` | プラグインフォルダ内 | プラグイン設定                                                             |

---

## 2. 詳細仕様（分冊）

各機能の詳細仕様は以下のドキュメントに分冊されている。

| ドキュメント                                | 内容                                                                 |
| :------------------------------------------ | :------------------------------------------------------------------- |
| [同期エンジン仕様](spec/sync-engine.md)     | Smart Sync / Full Scan / Index管理 / 割り込み制御 / 同期トリガー     |
| [競合解決仕様](spec/conflict-resolution.md) | 3-wayマージ / 楽観的ロック / 分散ロック / ancestorHashライフサイクル |
| [設定仕様](spec/settings.md)                | 全設定項目 / 同期スコープ / 除外パターン                             |
| [履歴機能仕様](spec/history.md)             | リビジョン管理 / Diff表示 / ロールバック                             |

## 3. テスト仕様（分冊）

| ドキュメント                                                 | 内容                                                        |
| :----------------------------------------------------------- | :---------------------------------------------------------- |
| [マージアルゴリズムテスト仕様](test-spec/merge-algorithm.md) | 3-wayマージの112テストケース / DMPパラメータ / 合否判定基準 |
| [同期シナリオテスト仕様](test-spec/sync-scenarios.md)        | 基本動作 / 競合検知 / 割り込み / 複数端末テスト             |

---

## 4. 対応プラットフォーム

- Windows / Mac / Linux / iOS / Android（全Obsidianプラットフォーム）

## 5. セキュリティ

- **認証スコープ**: Google Drive API `auth/drive`（グローバル検索・フォルダ移動のため）
- **認証情報保存**: Obsidian Secret Storage API (Keychain) を優先使用。未対応環境では `.sync-state`（AES-GCM暗号化バイナリ）に保存し、機密性を確保。
- **通信**: HTTPS のみ
- **楽観的ロック**: Push時にリモートハッシュを検証し、競合を検知
- **パストラバーサル防止**: 履歴API呼び出し時のパス検証
- **整合性検証**: ダウンロード時のMD5ハッシュ照合

## 6. 国際化 (i18n)

- Obsidianの言語設定（`window.localStorage.getItem("language")`）に連動
- 対応言語: 日本語 (ja) / 英語 (en, デフォルト)
