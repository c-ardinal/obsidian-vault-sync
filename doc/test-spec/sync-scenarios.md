# 同期シナリオ テスト仕様書

**親ドキュメント**: [仕様書](../specification.md)
**関連仕様**: [同期エンジン仕様](../spec/sync-engine.md) / [競合解決仕様](../spec/conflict-resolution.md)

---

## 1. 目的

同期エンジンの堅牢性を検証するためのユースケースを網羅的にテストする。基本動作・競合検知・割り込み/再キューイング・複数端末トポロジーの4カテゴリで構成される。

## 2. テスト環境

- **テストフレームワーク**: Vitest
- **モック**: `MockVaultAdapter`（ローカルファイルシステム）、`MockCloudAdapter`（クラウドストレージ）
- **シミュレーター**: `DeviceSimulator`（複数端末の同期動作をシミュレート）

---

## 3. 基本動作 (Normal Path)

| ID  | ケース名          | 条件                                               | 期待される動作                                               |
| :-- | :---------------- | :------------------------------------------------- | :----------------------------------------------------------- |
| N1  | 完全同期済み      | ローカル/リモート/インデックスのハッシュが全て一致 | 何もしない（Up to date通知）                                 |
| N2  | 単純Push          | ローカルのみ変更あり                               | ファイルアップロード → インデックス更新 (`lastAction: push`) |
| N3  | 単純Pull          | リモートのみ変更あり                               | ファイルダウンロード → インデックス更新 (`lastAction: pull`) |
| N4  | ローカル削除→Push | ローカルでファイル削除                             | リモート削除 → インデックスから削除                          |
| N5  | リモート削除→Pull | リモートでファイル削除                             | ローカル削除（ごみ箱） → インデックスから削除                |

## 4. 競合検知シナリオ (Conflict Path)

| ID  | タイトル                      | 検知タイミング                  | 詳細挙動                                                                        |
| :-- | :---------------------------- | :------------------------------ | :------------------------------------------------------------------------------ |
| C1  | **Push前検知**                | アップロード直前の検証時        | `smartPush` 中にリモートハッシュ不一致を検知 → `pullFileSafely` でマージ試行    |
| C2  | **Pull時検知 (Safety Guard)** | `smartPull` の実行開始直後      | リモート更新あり + ローカルに未送信変更 (`lastAction: push/merge`) → マージ試行 |
| C3  | **同期完了時検知**            | Changes APIでの自身のPush反映時 | ハッシュ一致なら `lastAction: pull` に正常遷移。別端末のPushがあればC2に遷移    |
| C4  | **マージロック競合**          | マージロック取得時              | 他端末が `communication.json` でロック保持中 → 待機またはリトライ               |
| C5  | **二重競合**                  | マージPush直前                  | マージ成功後のPush前にリモートが再更新 → 再度マージ                             |
| C6  | **バイナリ競合**              | 競合検知時                      | マージ不可 → Conflictファイル退避 + リモートPull                                |
| C7  | **編集vs削除衝突**            | 同期実行時                      | 編集優先（削除後に編集されたなら再アップロード）                                |

## 5. イベント割り込みと再キューイング (Interruption Path)

| ID  | タイトル                       | 割り込み内容                                | 期待される動作                                      |
| :-- | :----------------------------- | :------------------------------------------ | :-------------------------------------------------- |
| I1  | **単一イベント割り込み**       | 同期中に1度だけ `modify` 発生               | 現在の同期終了後、即座に次のSmart Syncが開始        |
| I2  | **連続イベント割り込み**       | 同期中に複数回 `modify` 発生                | 重複リクエストは統合され、同期終了後に1度だけ再同期 |
| I3  | **パラメータ統合 (Silent)**    | 同期中(Silent=true)に手動同期(Silent=false) | 次のパスでは通知表示あり（Non-silent優先）          |
| I4  | **フルスキャン割り込み**       | Background Full Scan中にSmart Sync発生      | Full Scanが中断され、Smart Sync実行。完了後に再開   |
| I5  | **中断後のインデックス整合性** | 同期中断直後                                | エラーやシャットダウン後の再起動でリカバリ          |

## 6. 複数端末トポロジー (Multi-Device Path)

| ID  | タイトル              | シナリオ                                                                                   | 難易度 |
| :-- | :-------------------- | :----------------------------------------------------------------------------------------- | :----- |
| M1  | **2端末: 同時編集**   | A,Bが編集 → AがPush成功 → BがPush時に検知してマージ → BがPush成功                          | 高     |
| M2  | **3端末: 逐次マージ** | AがPush → BがPull&編集 → Cが編集 → BがPush → CがPush時にマージ                             | 極高   |
| M3  | **3端末: ロック競合** | BとCが同時にAの変更をマージしようとする                                                    | 高     |
| M4  | **循環マージ防止**    | AとBが編集 → AがマージしてPush → BがPull時にマージ結果を子孫と認識してPull（再マージせず） | 高     |

---

## 7. 回帰テスト: 過去の障害パターン

以下は実際の運用で発生した障害を再現するテストケース。

### 7.1 ancestorHash汚染によるRevertループ

**背景**: マージ結果のハッシュがancestorHashとして永続化され、以降のマージで誤ったBaseが使用され続ける。

| ステップ | 操作                             | 検証ポイント                                          |
| :------- | :------------------------------- | :---------------------------------------------------- |
| 1        | A,Bが同時編集 → Aが先にPush      | -                                                     |
| 2        | BがPull時に競合検知 → マージ成功 | 正しいBase(元の共通祖先)が使用されること              |
| 3        | BがマージをPush                  | `ancestorHash` がマージ結果のハッシュに更新されること |
| 4        | AがPull → 最新版を取得           | AのancestorHashも正しく更新されること                 |

### 7.2 findCommonAncestorHash誤選択

**背景**: `Math.min(localIdx, remoteIdx)` で共通祖先を選択すると、localHash自体が返される場合がある。

| ステップ | 操作                                        | 検証ポイント                                       |
| :------- | :------------------------------------------ | :------------------------------------------------- |
| 1        | ancestorHashがlocalHashと一致する状態を作成 | 履歴検索が発動すること                             |
| 2        | findCommonAncestorHashが実行される          | localHashでもremoteHashでもないハッシュが返ること  |
| 3        | 有効な祖先が見つからない場合                | Conflictファイルが作成されること（誤マージしない） |

### 7.3 ゾンビ競合（Push後のancestorHash未更新）

**背景**: Push成功後にancestorHashが更新されないと、次回の競合で解決済み変更が再出現する。

| ステップ | 操作                                | 検証ポイント                             |
| :------- | :---------------------------------- | :--------------------------------------- |
| 1        | 同時編集 → 競合 → マージ成功 → Push | -                                        |
| 2        | Push成功後のancestorHashを確認      | マージ結果のハッシュに更新されていること |
| 3        | 一方で再編集 → 競合発生             | Base差分に解決済み変更が含まれないこと   |

## 8. 履歴機能テスト (History Path)

| ID  | タイトル               | 検証内容                           | 期待される動作                                                       |
| :-- | :--------------------- | :--------------------------------- | :------------------------------------------------------------------- |
| H1  | **履歴表示**           | 複数回編集・同期したファイル       | 正しい日時・順序で履歴が表示される                                   |
| H2  | **コンテンツ一致**     | 過去版をDLして当時の内容と比較     | バイナリ/エンコーディング含め完全一致                                |
| H3  | **Diff表示**           | 追加・削除・変更がある2バージョン  | ハイライトが正しく表示される                                         |
| H4  | **復元動作**           | ロールバック実行                   | ローカルファイルが過去の内容に戻る                                   |
| H5  | **同期連携**           | ロールバック後                     | 自動的にSmart Syncが走り、クラウドも復元内容で更新される             |
| H6  | **インデックス整合性** | 復元後の同期                       | `sync-index.json` が正しく更新され、無限ループ（再DL等）が発生しない |
| H7  | **ネットワーク切断**   | オフライン時に履歴を閲覧           | 適切なエラーメッセージが表示される                                   |
| H8  | **削除済みファイル**   | リモートで削除されたファイルの履歴 | エラーまたは「ファイルが存在しない」旨の表示                         |

## 9. パフォーマンステスト (Performance Path)

| ID  | タイトル         | 検証内容                              | 期待される動作                                        |
| :-- | :--------------- | :------------------------------------ | :---------------------------------------------------- |
| P1  | **Pullスキップ** | リモート未変更時                      | sync-index.jsonハッシュ比較のみでPullがスキップされる |
| P2  | **差分検出**     | リモート変更時                        | JSONダウンロード → 差分ファイルのみPullされる         |
| P3  | **Index更新**    | Push後                                | sync-index.jsonが正しく更新・アップロードされる       |
| P4  | **汎用動作**     | Changes API非対応アダプター（モック） | sync-index.jsonベースの同期が正常動作する             |
| P5  | **拡張動作**     | Changes API対応時                     | sync-index.json比較がスキップされ更に高速化される     |
| P6  | **マージ速度**   | 5000行以下のファイル                  | マージ処理が3秒以内に完了する                         |

---

## 10. テスト実装状況

| テストファイル                                          | 内容                               | ケース数 |
| :------------------------------------------------------ | :--------------------------------- | :------- |
| `tests/tests/code-scenario/conflict-resolution.test.ts` | 複数端末の競合解決シナリオ         | -        |
| `tests/tests/merge-algorithm/merge-algorithm.test.ts`   | 3-wayマージアルゴリズム精度検証    | 121      |
| `tests/tests/yaml-scenario/yaml-scenarios.test.ts`      | YAMLフロントマターのマージシナリオ | -        |
| `tests/tests/code-scenario/icon-behavior.test.ts`       | アイコン表示の動作検証             | -        |
