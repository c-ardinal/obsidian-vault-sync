# マージアルゴリズム テスト仕様書

**親ドキュメント**: [仕様書](../specification.md)
**関連仕様**: [競合解決仕様](../spec/conflict-resolution.md)

---

## 1. 目的

`diff-match-patch` (DMP) を利用した行ベースの3-wayマージエンジンの精度を検証し、データの予期せぬ消失（Silent Data Loss）や構造の破壊を防止する。

## 2. 検証環境（DMPパラメータ・前処理）

全入力（Base/Local/Remote）の改行コードを **LF (`\n`)** に正規化した上でマージ処理を行う。

| パラメータ              | 値                | 説明                                             |
| :---------------------- | :---------------- | :----------------------------------------------- |
| `Match_Threshold`       | 0.5               | 半分以上の文脈一致で位置特定                     |
| `Match_Distance`        | 250               | パッチの期待位置からこの行数以上ズレたら適用失敗 |
| `Patch_Margin`          | 4 → 2 → 1（動的） | 段階的リトライ。前後N行を文脈として考慮          |
| `Added-Line Protection` | 有効              | Localの追加行が消失したらマージ拒否              |
| `Intra-line Merge`      | 無効              | 将来の拡張課題                                   |

## 3. 合否判定基準

1. **データ消失ゼロ**: Added-line protectionにより、Local側の追加行が1行でも消えたら失敗
2. **構造維持**: YAML, テーブル, コードブロックの基本構文がマージ後に破壊されていないこと
3. **衝突検出の正確性**: 同一行内編集や探索距離超過時に不正マージせず `null`（衝突）を返すこと
4. **冪等性**: 同一入力に対するマージ結果が常に同一であること
5. **パフォーマンス**: 5000行以下のファイルでマージ処理が3秒以内に完了すること

## 4. テストケース詳細

### Group 1: YAML Frontmatter & Metadata (001-015)

独立編集の成功には、Baseにおいて各要素が独立した行であることを前提とする。

| ID  | Base                     | Local                  | Remote                | 期待結果                                   |
| :-- | :----------------------- | :--------------------- | :-------------------- | :----------------------------------------- |
| 001 | `tags: []\nstatus: todo` | `status: done`         | `tags: [work]`        | 両方反映 (tags: [work], status: done)      |
| 002 | `date: 01-01`            | `date: 01-02`          | `date: 01-01 (c)`     | **コンフリクト** (同一行編集)              |
| 003 | `title: Hello`           | `author: Alice` (追記) | `source: web` (追記)  | 独立行であれば維持                         |
| 004 | `desc: "L1\nL2"`         | `desc: "Mod1\nL2"`     | `desc: "L1\nMod2"`    | 別行の変更をマージ                         |
| 005 | `desc: "A\nB\nC"`        | `desc: "A\nB2\nC"`     | `desc: "A\nB\nC\nD"`  | 中間の更新と末尾の追加を両立               |
| 006 | `tags:\n - t1`           | `tags:\n - t1\n - t2`  | `tags:\n - t1\n - t3` | **マージ成功** (Block記法、各タグが独立行) |
| 007 | `tags: [t1]`             | `tags: [t1, t2]`       | `tags: [t1, t2]`      | 両側同一編集 → t2に収束                    |
| 008 | `tags: [x, y]`           | `tags: [y]`            | `tags: [x, y, z]`     | **コンフリクト** (同一行内編集)            |
| 009 | `a: 1\nb: 2`             | `a: 9\nb: 2`           | `a: 1\nb: 8`          | **マージ成功** (独立行)                    |
| 010 | `key: val`               | `key: A`               | `key: B`              | **コンフリクト** (null)                    |
| 011 | `--- (Start/End)`        | 冒頭にID追加           | 末尾にDate追加        | YAML構造を維持し両キー追加                 |
| 012 | `--- \n Body`            | YAML内編集             | Body内編集            | セパレーター位置を維持し両方反映           |
| 013 | `--- \n Text`            | `---` 削除             | Text編集              | **コンフリクト**（構造破壊）               |
| 014 | `[[Link1]]\n[[Link2]]`   | `[[Link1\|A]]`         | `[[Link2\|B]]`        | 両方のリンク修正を維持                     |
| 015 | `#tag1`                  | `#tag1` (削除)         | `#tag2` (追記)        | 別行であれば成功                           |

### Group 2: Markdown Tables (016-030)

| ID  | Base                 | Local               | Remote               | 期待結果                   |
| :-- | :------------------- | :------------------ | :------------------- | :------------------------- |
| 016 | `\| A \| B \|`       | `\| A2 \| B \|`     | `\| A \| B2 \|`      | **コンフリクト** (同一行)  |
| 017 | 10行テーブル         | 2行目セル修正       | 9行目セル修正        | 離れた行のセル更新を両立   |
| 018 | 3行テーブル          | 末尾にRow4追加      | 末尾にRow5追加       | Row4とRow5が並んで追加     |
| 019 | `Row1\nRow2`         | `Row1\nNew\nRow2`   | `Row1\nRow2\nNew2`   | 中間挿入と末尾追加を両立   |
| 020 | `Header\n---\nData1` | データの値を編集    | ヘッダー名を編集     | 表構造を維持 (別行)        |
| 021 | `\| 1 \| 2 \|`       | `\| 1 \| 2 \| 3 \|` | `\| 12 \|`           | **コンフリクト**           |
| 022 | `\| \| \n\| \|`      | 1行目埋め           | 2行目埋め            | 別行であればマージ成功     |
| 023 | 5行テーブル          | 2行目を削除         | 4行目を編集          | 削除行以外は反映           |
| 024 | `\| A \|`            | `\| B \|`           | `\| C \|`            | **コンフリクト** (null)    |
| 025 | 1行テーブル          | 奇数行追加(3,5)     | 偶数行追加(2,4)      | 全ての行が順序よく並ぶ     |
| 026 | `Text\nTable`        | Textを大幅加筆      | 表内の値を編集       | 文脈を見失わず両方反映     |
| 027 | `Table\nText`        | 表の下に追記        | 表内の値を編集       | 境界を超えず両方反映       |
| 028 | 200行テーブル        | 5行目編集 (Unique)  | 150行目編集 (Unique) | 文脈がユニークなら成功     |
| 029 | `\| A \| B \|`       | `\| A \| B \| C \|` | (Bのカラム削除)      | **コンフリクト**（不整合） |
| 030 | `T1\n...\nT2`        | T1内編集            | T2内編集             | 別々のテーブルの変更を両立 |

### Group 3: Task List & Nested List (031-050)

| ID  | Base                 | Local                 | Remote              | 期待結果                         |
| :-- | :------------------- | :-------------------- | :------------------ | :------------------------------- |
| 031 | `- [ ] T1\n- [ ] T2` | `- [x] T1`            | `- [x] T2`          | 両方のタスクが完了               |
| 032 | `- T1`               | `- New\n- T1`         | `- T1\n- End`       | 先頭と末尾に項目追加             |
| 033 | `- T1\n- T2`         | `- T1\n- A\n- T2`     | `- T1\n- B\n- T2`   | 決定論的挿入 (Local A, Remote B) |
| 034 | `- Item`             | `\t- Item`            | `- Item` (編集)     | **コンフリクト** (同一行)        |
| 035 | `L1\n\tL2\n\t\tL3`   | L3編集                | L1編集              | 階層を維持して両方反映           |
| 036 | `- A\n- B`           | `- B` (A削除)         | `- A\n- B` (B編集)  | A削除とB編集を両立               |
| 037 | `- Item`             | `* Item` (記法)       | `- Item` (修正)     | **コンフリクト** (同一行)        |
| 038 | `1. A\n2. B`         | `1. A\n1.1 New\n2. B` | `1. A\n2. B` (修正) | 中間挿入と編集の両立             |
| 039 | `- [ ] Task`         | `- [x] Task`          | `- [x] Task`        | 同一編集による収束               |
| 040 | `- Task\n note`      | `- Task-upd`          | `note-upd`          | 親編集と継続行編集の両立         |
| 041 | 10行リスト           | 奇数行を完了          | 偶数行を完了        | 10行全て完了                     |
| 042 | `- A\n- B`           | `- B\n- A` (入替)     | `- A-mod`           | **コンフリクト** (移動)          |
| 043 | `L1\n\nL2`           | L1上の空行編集        | L2上の空行編集      | 空行の整合性維持                 |
| 044 | `\t- Item`           | `- Item` (戻す)       | `\t- Item 加筆`     | **コンフリクト** (同一行)        |
| 045 | 10個のタスク         | 上5個を完了           | 下5個を完了         | 10個全て完了                     |
| 046 | Bullet + Num         | Bullet追加            | Num追加             | 別行の構造を維持                 |
| 047 | `- Line\n Cont`      | Cont編集              | Line編集            | 親・継続行の独立マージ成功       |
| 048 | `- [ ] T1 #tag`      | `#tag` 変更           | `- [x] T1`          | **コンフリクト** (同一行)        |
| 049 | Level 5 List         | L5編集                | L1編集              | 離れた階層の独立マージ成功       |
| 050 | `- [Link](uri)`      | Label更新             | uri更新             | **コンフリクト** (同一行)        |

### Group 4: Code Blocks (051-065)

| ID  | Base              | Local                      | Remote            | 期待結果                             |
| :-- | :---------------- | :------------------------- | :---------------- | :----------------------------------- |
| 051 | `func() {\n}`     | `// Comment` (L1)          | `\treturn;` (LN)  | 関数冒頭と末尾の両方反映             |
| 052 | `{ \n a=1\n}`     | `\t\ta=1` (インデント修正) | `a=2` (内容修正)  | **コンフリクト** (同一行)            |
| 053 | ` ```py `         | ` ```python `              | block内編集       | 言語タグ変更と中身の両立             |
| 054 | `` `\na\n` ``     | `` `\na\nb\n` ``           | `` `\na\nc\n` ``  | ブロック末尾への連続追加。両立       |
| 055 | `text\n`\n...\n`` | text修正                   | code修正          | 物理的境界を越えず独立反映           |
| 056 | `B1\n...\nB2`     | B1内のみ編集               | B2内のみ編集      | 別のブロックの混同なし               |
| 057 | `}\n}\n}`         | 中間の`}`を`]`へ           | 足りない`}`を追記 | 前後の文脈で位置特定                 |
| 058 | `if (c) {`        | `if (c) { // upd`          | (行削除)          | **コンフリクト**（消された行の編集） |
| 059 | `/* doc */`       | doc内容修正                | 末尾に`@param`    | コメントブロック内の両立             |
| 060 | `config: val`     | `config: new`              | `another: key`    | 別々の設定キーの両立                 |
| 061 | Python Code       | インデント(L4)             | ロジック修正(L6)  | 別行の構造維持                       |
| 062 | CSS Braces        | property加筆               | selector名変更    | セレクタ変更とプロパティ加筆両立     |
| 063 | SQL Query         | JOIN追記                   | WHERE修正         | 複数行のSQLを壊さずマージ            |
| 064 | `<script>`        | tag内編集                  | tag外編集         | HTML/Scriptタグペアを維持            |
| 065 | Embedded MD       | 内部MDの`#`編集            | 外部MDへの追記    | 入れ子構文の整合性維持               |

### Group 5: Daily Journal & Logs (066-085)

| ID  | Base          | Local                 | Remote                     | 期待結果                              |
| :-- | :------------ | :-------------------- | :------------------------- | :------------------------------------ |
| 066 | `Start\nEnd`  | Morning Add           | Night Add                  | 冒頭と末尾の追加。両立                |
| 067 | `10:00 Log`   | `11:00 Insert`        | `12:00 Insert`             | 時間順に並んで挿入                    |
| 068 | `L1\nL2`      | `L1\nL1.1\nL2`        | `L1\nL2-mod`               | 挿入と既存行編集の両立                |
| 069 | `Hello`       | `Hello-fix`           | `Hello-dot`                | **コンフリクト** (同一行)             |
| 070 | `Old Log`     | `Old Log` (upd)       | `New Log` (app)            | 過去修正と新規追記の両立              |
| 071 | Rapid Logs    | 3回連続追記           | 1点編集                    | 履歴バースト中の変更を欠損させない    |
| 072 | 300行ファイル | 20行目を編集 (小修正) | 先頭に300行挿入 (ズレ発生) | **Match_Distance(250)超過衝突**       |
| 073 | `A\n\n\nB`    | 2つ目の空行注記       | 3つ目の空行注記            | 連続空行内の位置特定に成功            |
| 074 | `L1\nL2`      | L1 (L2と結合)         | L2 (内容編集)              | **コンフリクト** (結合元が編集された) |
| 075 | `ID: 001`     | `ID: 002` (修正)      | `Desc: text` (加筆)        | **コンフリクト** (同一行)             |
| 076 | `文1\n文2`    | 文1修正               | 文2加筆                    | 日本語の独立行編集成功                |
| 077 | `(かっこ)`    | 内容を`(詳細)`        | `)` 外へ加筆               | **コンフリクト** (同一行)             |
| 078 | `文1\n文2`    | 文1修正               | 文2修正                    | 独立行であれば成功                    |
| 079 | `文1\n文2`    | 中間に改行            | 文2修正                    | 行の分割と別行編集の両立              |
| 080 | 😃\n🚀        | 😄 (置換)             | 🛸 (追記)                  | サロゲートペアを正確に扱う            |
| 081 | Space         | 全角→半角             | 追記                       | **コンフリクト** (同一行)             |
| 082 | `Eng\nJp`     | Eng修正               | Jp修正                     | 英和独立行編集成功                    |
| 083 | 多重空行      | 空行的位置維持        | 文章修正                   | 空間コンテキストを壊さない            |
| 084 | `[http://..]` | httpsへ修正           | `[Label]`へ修正            | **コンフリクト** (同一行)             |
| 085 | `[^1]: Ref`   | Ref内容修正           | 本文に`[^1]`               | 脚注定義と参照の独立編集成功          |

### Group 6: Structural & Scale (086-100)

| ID  | Base                         | Local             | Remote            | 期待結果                        |
| :-- | :--------------------------- | :---------------- | :---------------- | :------------------------------ |
| 086 | Chapter A                    | 移動              | 内容修正          | **コンフリクト** (移動)         |
| 087 | 100行テキスト                | 10行削除          | 最終行編集        | 削除と編集を両立                |
| 088 | 全文                         | (Local) 全消去    | 1行修正           | **Mass Deletion検出により阻止** |
| 089 | `P1\nP2`                     | `P2\nP1` (入替)   | P1加筆            | **コンフリクト** (移動)         |
| 090 | サロゲート1\n2               | サロゲート1置換   | サロゲート2置換   | Unicode列を壊さず成功           |
| 091 | `$ \alpha $\n$ \beta $`      | `$ \gamma $` (L1) | `$ \delta $` (L2) | **マージ成功** (数式独立行)     |
| 092 | `<div>\n</div>`              | 属性追記          | 境界外へ加筆      | タグペアを維持                  |
| 093 | `> [!INFO] Title\n> content` | Title修正 (L1)    | 中身加筆 (L2)     | **マージ成功** (別行)           |
| 094 | `URL1\nURL2`                 | URL1修正          | URL2修正          | 独立URL行の同時修正成功         |
| 095 | (BOMあり)                    | 文字列追記        | BOM削除           | エンコード不整合を検知/防止     |
| 096 | (Base=空)                    | Local 1行追記     | (なし)            | マージ成功 (Localのみ)          |
| 097 | 2000行ファイル               | 1000行目編集      | 1005行目編集      | 位置不変のため成功              |
| 098 | 5000行ファイル               | プロパティ修正    | 文末追記          | 3秒以内に完了すること           |
| 099 | `Tab行\nSpace行`             | Tab行修正         | Space行修正       | インデント種別を破壊せず共存    |
| 100 | `<!-- comment -->`           | 内部修正          | 外部修正          | コメントアウト構造を維持        |

### Group 7: Boundary & Edge (101-112)

| ID  | カテゴリ       | Base                 | Local              | Remote             | 期待結果                    |
| :-- | :------------- | :------------------- | :----------------- | :----------------- | :-------------------------- |
| 101 | Head           | Line1 (Long)         | `New\nLine1`       | `Line1-mod`        | 文字列長があれば成功        |
| 102 | Tail           | LineN (Long)         | `LineN\nNew`       | `LineN-mod`        | EOF付近の整合性維持         |
| 103 | AlphabetMix    | `あAいBうC`          | `あXいBうC`        | `あAいBうY`        | **コンフリクト** (同一行)   |
| 104 | References     | `[10]: R10\n[1]: R1` | `[10]: New`        | `[1]: New`         | 参照リストの独立行編集成功  |
| 105 | 重複見出し     | `## Title (1)`       | `## Title (1) + A` | `## Title (1) + B` | 同一文脈の別行挿入成功      |
| 106 | 同一編集       | `text`               | `modified`         | `modified`         | 1つの `modified` に収束     |
| 107 | 同一削除       | `A\nB\nC`            | `A\nC` (B削除)     | `A\nC` (B削除)     | エラーなく削除反映          |
| 108 | 改行コード A   | LF                   | CRLF化             | LF (内容編集)      | 内容編集＋正規化収束        |
| 109 | 改行コード B   | (混在)               | LF正規化           | CRLF正規化         | 最終的にLFに統一            |
| 110 | 空Base         | (空)                 | Aが入力            | Bが入力            | 行単位で並び両方存在        |
| 111 | 冪等性         | (任意)               | (任意)             | (任意)             | 2回等価マージして結果が不変 |
| 112 | 衝突見逃しゼロ | (明らかな衝突)       | A編集              | B編集              | 確定的に `null` を返すこと  |

## 5. 既知の限界事項と定着した振る舞い

以下は行ベースDMP実装における仕様上の限界、または意図された安全動作として定着した振る舞いである。

| 項目                      | 説明                                                                                     |
| :------------------------ | :--------------------------------------------------------------------------------------- |
| **行内マージの非対応**    | 同一行に対する編集は、オフセットが異なっていても原則として競合 (null) を返す             |
| **移動の追跡不能**        | 行の移動（Swap）はAdded-line protectionにより「Local行の消失」と判定され高確率で競合     |
| **DMPによる強引なマージ** | 文脈が極端に短い場合、パッチ適用が「成功」と判定され期待される競合が発生しないことがある |
| **決定論的順序**          | 同一箇所への行挿入がLocal/Remote両側で発生した場合、Remote→Localの順序でマージ           |
| **過度な安全保護**        | 本来マージ可能な変更でも、行の同一性が担保できない場合は安全のため競合を返す             |

## 6. 検証結果サマリー

| 項目                                     | 結果                                           |
| :--------------------------------------- | :--------------------------------------------- |
| **テストケース総数**                     | 121（112 + 補助9件）                           |
| **Pass**                                 | 121 (100%)                                     |
| **Conflict (Expected null/Actual null)** | 22件                                           |
| **DMPパラメータ最終設定**                | Margin=4→2→1 動的、Threshold=0.5、Distance=250 |
